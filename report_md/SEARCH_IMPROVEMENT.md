# 知识库搜索功能改进说明

## 改进概述

原始的搜索功能只使用简单的字符串精确匹配，这导致以下问题：

- 无法处理同义词和相近词汇
- 不能理解查询的语义含义
- 对复杂问句的关键词提取能力差
- 搜索结果相关性评分不准确

## 改进后的功能特性

### 1. 智能文本预处理

- **中文分词**: 使用jieba分词库进行精确的中文分词
- **文本清洗**: 去除无关字符，规范化空白字符
- **停用词过滤**: 过滤常见的无意义词汇
- **关键词提取**: 基于词性标注提取名词、动词、形容词作为关键词

### 2. 多层次匹配算法

- **TF-IDF向量匹配**: 使用词频-逆文档频率算法计算文档相关性
- **关键词匹配**: 提取查询中的关键词进行精确和模糊匹配
- **模糊匹配**: 使用序列匹配算法处理相似词汇
- **N-gram支持**: 支持1-2元语法模型提高匹配准确性

### 3. 智能评分系统

- **综合评分**: 结合TF-IDF分数、关键词匹配分数和文本匹配分数
- **权重调整**: 不同匹配类型使用不同权重
- **动态阈值**: 根据搜索结果自动调整匹配阈值

### 4. 相关内容提取

- **智能片段提取**: 自动提取包含关键词的相关文本片段
- **上下文保持**: 保持提取片段的语义完整性
- **长度控制**: 控制返回片段的长度，避免信息过载

## 新增依赖包

```
jieba==0.42.1           # 中文分词
scikit-learn==1.3.0     # 机器学习算法（TF-IDF等）
numpy==1.24.3           # 数值计算
difflib                 # 序列匹配（Python内置）
```

## API接口更新

### 新增搜索测试接口

```
POST /api/search
{
    "query": "用户查询内容"
}
```

返回结果包含更详细的匹配信息：

```json
{
    "query": "查询内容",
    "results": [
        {
            "document_id": 1,
            "filename": "文档名称",
            "content": "相关内容片段",
            "score": 总分,
            "tfidf_score": "TF-IDF分数",
            "keyword_score": "关键词匹配分数",
            "matched_keywords": ["匹配的关键词列表"]
        }
    ],
    "total_results": 结果数量
}
```

## 使用说明

### 1. 安装依赖

运行 `install_search_deps.bat` 安装新的依赖包。

### 2. 测试搜索功能

运行 `python test_search.py` 测试改进后的搜索功能。

### 3. 重启应用

由于添加了新的依赖，需要重启后端应用：

```cmd
cd backend
python app.py
```

## 搜索效果对比

### 原始搜索

- 查询: "什么是人工智能？"
- 结果: 只能匹配包含完整问句的文档

### 改进后搜索  

- 查询: "什么是人工智能？"
- 关键词提取: ["人工智能"]
- 匹配策略:
  - 精确匹配"人工智能"
  - 模糊匹配"AI"、"Artificial Intelligence"
  - 相关概念匹配"机器学习"、"深度学习"等

## 性能优化

1. **索引缓存**: TF-IDF矩阵在内存中缓存，避免重复计算
2. **增量更新**: 添加/删除文档时自动重建搜索索引
3. **阈值调整**: 根据结果质量动态调整匹配阈值
4. **结果限制**: 限制返回结果数量，提高响应速度

## 后续优化建议

1. **语义搜索**: 集成词向量模型进行语义相似度计算
2. **搜索历史**: 记录用户搜索历史，优化个性化推荐
3. **多语言支持**: 扩展支持英文等其他语言的搜索
4. **实时索引**: 实现增量索引更新，提高大量文档的处理效率
